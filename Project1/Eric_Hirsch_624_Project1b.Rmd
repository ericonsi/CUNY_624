---
title: "Eric_Hirsch_624_Homework_5"
output: html_document
date: "2023-02-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}

library(tidyverse)
library(tsibble)
library(fpp3)
library(EHData)
library(gridExtra)
library(fable)
library(readxl)

```

1. First we read in the data and look for missing values.  

There are 19 records with missing values in the dataset, including 14 with a missing ATM (they all represent days from the month of May 2010, which is what we are predicting.)  This leaves 5 missing cash values - we use ARIMA to impute them.

Then we separate the original tsibble into 4 tsibbles, each representing one ATM.

```{r}

dfATM <- as.data.frame(read_excel("D:\\RStudio\\CUNY_624\\Project1\\ATM624Data.xlsx"))

summary(dfATM)
str(dfATM)

print("Missing ATM: ")
which(is.na(dfATM$ATM))
print("Missing Cash: ")
which(is.na(dfATM$Cash))

CreateAtmTsibble <- function(filter) {
  
  ts <- dfATM %>%
  filter(ATM==filter)%>%
  mutate(xDate=as_date(DATE)) %>%
  as_tsibble(index=xDate) %>%
  dplyr::select(xDate, Cash)
  
  ts <- ts %>%
  model(ARIMA(Cash)) %>%
  interpolate(ts)
  
  return (ts)
}

tsATM1a <- CreateAtmTsibble("ATM1")
tsATM2a <- CreateAtmTsibble("ATM2")
tsATM3 <- CreateAtmTsibble("ATM3")
tsATM4 <- CreateAtmTsibble("ATM4")

lambda <- tsATM1a %>%
  features(Cash, features = guerrero) %>%
  pull(lambda_guerrero)

#tsATM1a <- tsATM1a %>%
 # mutate(Cash=box_cox(Cash, lambda))

```

2. Examine ATM1

First we look a the data. It shows a number of strange patterns, not the least of which is that the money removed from the ATMs is not in multiples of twenty.  Also, the distribution is bimodal.  There are possible outliers but none of them are too out of range. Since we have no contextual information, we simply move forward.

```{r, fig.height=2}

dfCash1 <- as.data.frame(tsATM1a$Cash)
a <- EHSummarize_SingleColumn_Boxplots(dfCash1)
b <- EHSummarize_SingleColumn_Histograms(dfCash1)

grid.arrange(grobs=c(a,b), ncol=2)
c


```

3. Forecast ATM1

a. We will train the model on 75% of the data.

```{r, fig.height=2}

train1 <- tsATM1a %>%
  filter_index(~ "2010-01-31")

test1 <- tsATM1a %>%
  filter_index("2010-02-1" ~ .)

set.seed(042760)

forecast::autoplot(tsATM1a, Cash) +
  autolayer(test1, Cash, colour = "red") + labs(title = "ATM1, Training Data is <= January") 


```

b. Now we try different models.

```{r}

fit <- train1 %>%
  model(SNAIVE = SNAIVE(), ETS_AAN = ETS(Cash ~ error("A") + trend("A") + season("N")), ETS_AAA = ETS(Cash ~ error("A") + trend("A") + season("A")), ETS_AAdA = ETS(Cash ~ error("A") + trend("Ad", phi=.85) + season("A")), ARIMA=ARIMA(Cash))

#fit <- train1 %>%
#  model(SNAIVE = SNAIVE(), ETS_AAN = ETS(Cash ~ error("A") + trend("A") + season("N")), ETS_AAA = ETS(Cash ~ error("A") + trend("A") + season("A")), ETS_AAdA = ETS(Cash ~ error("A") + trend("Ad", phi=.85) + season("A")))

resids <- function(model) {
a <- fit[model] %>% gg_tsresiduals + labs(title=model)
return (a)
}
```

```{r, include=FALSE}

z <- list()
plot_list <- list()

for (i in names(fit)) {
  index=1
  
  x <- resids(i)
  p <- eval(substitute(x, list(i=index)))
  plot_list[[i]] <- p 
  
  index=index+1
}
```

```{r, fig.height=9}

grid.arrange(grobs=c(plot_list$SNAIVE[1:3], plot_list$ETS_AAN[1:3], plot_list$ETS_AAA[1:3], plot_list$ETS_AAdA[1:3], plot_list$ARIMA[1:3]), ncol=3)

```

```{r, fig.height=4}

fc <- fit %>%
  forecast(test1)

fc %>% forecast::autoplot(tsATM1a) + labs(title = "ATM1, Training Data is <= January") 

fit %>% accuracy()
fc %>% accuracy(test1)
```

d. Now we apply models to forecast the data.


```{r}
fit1d <- tsATM1a %>%
  model(ETS(Cash ~ error("A") + trend("A") + season("N")))
  
fc1d <- fit1d %>%
  forecast(h = 31)

fc1d %>%
  forecast::autoplot(tsATM1a) +
  geom_line(aes(y = .fitted), col="#D55E00",
            data = augment(fit1d)) +
  labs(y="Count", title="ATM1 - ETS AAN") +
  guides(colour = "none")

report(fit1d)
sum(fc1d$.mean)


```

Arima
boxcox 79.8
Regular 49
diff 1: 
diff 2: 



Using ARIMA for the forecast
2401 for May

```{r}


fit1d <- tsATM1a %>%
    model(ARIMA(Cash ~ 0 + pdq(2,0,0) + PDQ(0,1,1)))  
  
fc1d <- fit1d %>%
  forecast(h = 31)

fc1d %>%
  forecast::autoplot(tsATM1a) +
  geom_line(aes(y = .fitted), col="#D55E00",
            data = augment(fit1d)) +
  labs(y="Count", title="ATM1 - ETS AAN") +
  guides(colour = "none")

report(fit1d)
sum(fc1d$.mean)


```
SNAIVE forecast
2408

```{r}

fit1d <- tsATM1a %>%
    model(SNAIVE(Cash))
  
fc1d <- fit1d %>%
  forecast(h = 31)

fc1d %>%
  forecast::autoplot(tsATM1a) +
  geom_line(aes(y = .fitted), col="#D55E00",
            data = augment(fit1d)) +
  labs(y="Count", title="ATM1 - SNaive") +
  guides(colour = "none")

report(fit1d)
sum(fc1d$.mean)

```



Model4

Outliers

```{r}

summary(tsATM4)
dfCash4 <- as.data.frame(tsATM4$Cash)
EHSummarize_SingleColumn_Boxplots(dfCash4)
EHSummarize_SingleColumn_Histograms(dfCash4)


```
Remove outlier

```{r}

tsATM4a <- tsATM4  %>%
  mutate(Cash=ifelse(Cash>10000, 109, Cash))

```


```{r}

tsATM4a <- tsATM4a |> mutate(Cash=log(Cash))

train4 <- tsATM4a %>%
  filter_index(~ "2010-01-31")

test4 <- tsATM4a %>%
  filter_index("2010-02-1" ~ .)

set.seed(042760)

forecast::autoplot(tsATM4a, Cash) +
  autolayer(test4, Cash, colour = "red") + labs(title = "ATM4, Training Data is < January") 


```
Test  Models 4

```{r}
  
train1 <- train4

test1 <- test4

fit <- train1 %>%
  model(SNAIVE = SNAIVE(), ETS_AAN = ETS(Cash ~ error("A") + trend("A") + season("N")), ETS_AAA = ETS(Cash ~ error("A") + trend("A") + season("A")), ETS_AAdA = ETS(Cash ~ error("A") + trend("Ad", phi=.85) + season("A")), ARIMA=ARIMA(Cash))

resids <- function(model) {
a <- fit[model] %>% gg_tsresiduals + labs(title=model)
return (a)
}
```

```{r, include=FALSE}

z <- list()
plot_list <- list()

for (i in names(fit)) {
  index=1
  
  x <- resids(i)
  p <- eval(substitute(x, list(i=index)))
  plot_list[[i]] <- p 
  
  index=index+1
}
```

```{r, fig.height=9}

grid.arrange(grobs=c(plot_list$SNAIVE[1:3], plot_list$ETS_AAN[1:3], plot_list$ETS_AAA[1:3], plot_list$ETS_AAdA[1:3], plot_list$ARIMA[1:3]), ncol=3)

```

```{r, fig.height=4}

fc <- fit %>%
  forecast(test1)

fc %>% forecast::autoplot(tsATM4a) + labs(title = "KWH") 

fit %>% accuracy()
fc %>% accuracy(test1)
```

Apply best model to test data
AAN - 2470 for May



```{r}
fit4d <- tsATM4a %>%
  model(ETS(Cash ~ error("A") + trend("A") + season("N")))
  
fc4d <- fit4d %>%
  forecast(h = 31)

fc4d %>%
  forecast::autoplot(tsATM4a) +
  geom_line(aes(y = .fitted), col="#D55E00",
            data = augment(fit4d)) +
  labs(y="Count", title="ATM1 - ETS AAN") +
  guides(colour = "none")

report(fit4d)
sum(fc4d$.mean)


```

Forecast ARIMA
Sum: 3181

```{r}

fit4d <- tsATM4a %>%
      model(ARIMA(Cash ~ 0 + pdq(0,0,0) + PDQ(1,0,0)))  
  
fc4d <- fit4d %>%
  forecast(h = 31)

fc4d %>%
  forecast::autoplot(tsATM4a) +
  geom_line(aes(y = .fitted), col="#D55E00",
            data = augment(fit4d)) +
  labs(y="Count", title="ATM4 - ETS AAN") +
  guides(colour = "none")

report(fit4d)
sum(fc4d$.mean)

```



Outliers

```{r}

summary(tsATM2a)
dfCash2 <- as.data.frame(tsATM2a$Cash)
EHSummarize_SingleColumn_Boxplots(dfCash2)
EHSummarize_SingleColumn_Histograms(dfCash2)


```

Turn to monthly
```{r}
  
tsATM2b <- tsATM2a %>%
  as.data.frame() %>%
  group_by(Month=yearmonth(xDate)) %>%
  dplyr::summarize(MonthlyCash=sum(Cash)) %>%
  as_tsibble(index="Month")

forecast::autoplot(tsATM2a)
forecast::autoplot(tsATM2b)

  stl<- tsATM2a %>%
  stl(s.window ="periodic")
  forecast::autoplot(stl)

```


```{r}

train2m <- tsATM2b %>%
  filter_index(~ "2010 Feb")

fit2m <- tsATM2b %>%
  model(ETS(MonthlyCash ~ error("A") + trend("A") + season("N")))
  
fc2m <- fit2m %>%
  forecast(h = 3)

fc2m %>%
  forecast::autoplot(tsATM2b) +
  geom_line(aes(y = .fitted), col="#D55E00",
            data = augment(fit2m)) +
  labs(y="Count", title="ATM1 - ETS AAN") +
  guides(colour = "none")

report(fit2m)
fc2m$.mean

```
do it a daily

```{r}
fit2d <- tsATM2a %>%
  model(ETS(Cash ~ error("A") + trend("A") + season("A")))
  
fc2d <- fit2d %>%
  forecast(h = 31)

fc2d %>%
  forecast::autoplot(tsATM2a) +
  geom_line(aes(y = .fitted), col="#D55E00",
            data = augment(fit2d)) +
  labs(y="Count", title="ATM2 - ETS AAA") +
  guides(colour = "none")

report(fit2d)
sum(fc2d$.mean)



```

Test  Models 2

```{r}
train2 <- tsATM2a %>%
  filter_index(~ "2010-01-31")

test2 <- tsATM2a %>%
  filter_index("2010-02-1" ~ .)

set.seed(042760)

forecast::autoplot(tsATM2a, Cash) +
  autolayer(test2, Cash, colour = "red") + labs(title = "ATM2, Training Data is < January") 


```

SNAIVE

Test RMSE = 58.58

```{r}

fit2 <- train2 %>%
  model(SNAIVE())

fit2 %>% gg_tsresiduals()

fc2 <- fit2 %>%
  forecast(new_data = anti_join(tsATM4a, train4))

fc2 %>% forecast::autoplot(tsATM4a) + labs(title = "ATM2, Training Data is < January") 

fit2 %>% accuracy()
fc2 %>% accuracy(test2)
```
ETS AAN 

RMSE 39.43

```{r}

fit2 <- train2 %>%
  model(ETS(Cash ~ error("A") + trend("A") + season("N")))

fit2 %>% gg_tsresiduals()

fc2 <- fit2 %>%
  forecast(new_data = anti_join(tsATM2a, train2))
fc %>% forecast::autoplot(tsATM2a) + labs(title = "ATM2, Training Data is < January") 

fit2 %>% accuracy()
fc2 %>% accuracy(test2)
```

ETS AAA

RMSE 59.28

```{r}

fit2 <- train2 %>%
  model(ETS(Cash ~ error("A") + trend("A") + season("A")))

fit2 %>% gg_tsresiduals()

fc2 <- fit2 %>%
  forecast(new_data = anti_join(tsATM2a, train2))
fc2 %>% forecast::autoplot(tsATM2a) + labs(title = "ATM4, Training Data is < January") 

fit2 %>% accuracy()
fc2 %>% accuracy(test2)
```
ETS AAdA (.85)

RMSE 373.92

```{r}

fit4 <- train4 |>
  model(ETS(Cash ~ error("A") + trend("Ad", phi=.85) + season("A")))

fit4 %>% gg_tsresiduals()

fc4 <- fit4 %>%
  forecast(new_data = anti_join(tsATM4a, train4))
fc4 %>% forecast::autoplot(tsATM4a) + labs(title = "ATM4, Training Data is < January") 

fit4 %>% accuracy()
fc4 %>% accuracy(test4)
```
Boxcox AAN
309.58

```{r}

lambda <- tsATM4a %>%
  features(Cash, features = guerrero) %>%
  pull(lambda_guerrero)

tsATM4a_boxcox <- tsATM4a %>% 
  mutate(Cash=box_cox(Cash, lambda))

train4_boxcox <- tsATM4a %>%
  filter_index(~ "2010-01-31")

fit4 <- train4_boxcox %>%
  model(ETS(Cash ~ error("A") + trend("A") + season("N")))

fit4 %>% gg_tsresiduals()

fc4 <- fit4 %>%
  forecast(new_data = anti_join(tsATM4a_boxcox, train4_boxcox))
fc %>% forecast::autoplot(tsATM4a_boxcox) + labs(title = "ATM4, Training Data is < January") 

fit4 %>% accuracy()
fc4 %>% accuracy(test4)

```


```{r}
fit4d <- tsATM4a %>%
  model(ETS(Cash ~ error("A") + trend("A") + season("N")))
  
fc4d <- fit4d %>%
  forecast(h = 31)

fc4d %>%
  forecast::autoplot(tsATM4a) +
  geom_line(aes(y = .fitted), col="#D55E00",
            data = augment(fit4d)) +
  labs(y="Count", title="ATM1 - ETS AAN") +
  guides(colour = "none")

report(fit4d)
sum(fc4d$.mean)


```

ARIMA
RMSE 56 (Boxcox)
RMSE 60 (Regular)
```{r}


  train2 |> ACF(Cash) %>% autoplot() + labs(title="Cash")
  train2 |> PACF(Cash) %>% autoplot() + labs(title="Cash")

fit_Arim <- train2 |>
    model(ARIMA(Cash))

report(fit_Arim)

fit_Arim %>% gg_tsresiduals()

fc <- fit_Arim %>%
  forecast(new_data = test2, h=31)
fc %>% forecast::autoplot(tsATM4a) + labs(title = "ATM2, Training Data is < January") 

fit_Arim %>% accuracy()
fc %>% accuracy(test2)
#1,0,0 2,0,0 [7]

lambda <- tsATM2a %>%
  features(Cash, features = guerrero) %>%
  pull(lambda_guerrero)

fit_Arim <- train2 |>
    model(ARIMA(box_cox(Cash, lambda)))

report(fit_Arim)

fit_Arim %>% gg_tsresiduals()

fc <- fit_Arim %>%
  forecast(new_data = test2, h=31)
fc %>% forecast::autoplot(tsATM2a) + labs(title = "ATM2, Training Data is < January") 

fit_Arim %>% accuracy()
fc %>% accuracy(test2)





```


Outliers

```{r}

summary(tsATM3)
dfCash3 <- as.data.frame(tsATM3$Cash)
EHSummarize_SingleColumn_Boxplots(dfCash3)
EHSummarize_SingleColumn_Histograms(dfCash3)


```
Remove outlier

```{r}

tsATM4a <- tsATM4  %>%
  mutate(Cash=ifelse(Cash>10000, 109, Cash))

```

Turn to monthly
```{r}
  
tsATM4b <- tsATM4a %>%
  as.data.frame() %>%
  group_by(Month=yearmonth(xDate)) %>%
  dplyr::summarize(MonthlyCash=sum(Cash)) %>%
  as_tsibble(index="Month")

forecast::autoplot(tsATM4a)
forecast::autoplot(tsATM4b)

  stl<- tsATM4a %>%
  stl(s.window ="periodic")
  forecast::autoplot(stl)

```


```{r}

train4m <- tsATM4b %>%
  filter_index(~ "2010 Feb")

fit4m <- tsATM4b %>%
  model(ETS(MonthlyCash ~ error("A") + trend("A") + season("N")))
  
fc4m <- fit4m %>%
  forecast(h = 3)

fc4m %>%
  forecast::autoplot(tsATM4b) +
  geom_line(aes(y = .fitted), col="#D55E00",
            data = augment(fit4m)) +
  labs(y="Count", title="ATM1 - ETS AAN") +
  guides(colour = "none")

report(fit4m)
fc4m$.mean

```
do it a daily

```{r}
fit4d <- tsATM4a %>%
  model(ETS(Cash ~ error("A") + trend("A") + season("N")))
  
fc4d <- fit4d %>%
  forecast(h = 31)

fc4d %>%
  forecast::autoplot(tsATM4a) +
  geom_line(aes(y = .fitted), col="#D55E00",
            data = augment(fit1d)) +
  labs(y="Count", title="ATM1 - ETS AAN") +
  guides(colour = "none")

report(fit4d)
sum(fc4d$.mean)



```

```{r}

dfForecast <- as.data.frame(read_excel("D:\\RStudio\\CUNY_624\\Project1\\ForecastLoad.xlsx"))

tsForecast <- dfForecast |>
  rename("Month" = "YYYY-MMM") |>
  mutate(Month=yearmonth(Month)) |>
  as_tsibble(index=Month)
  

summary(dfForecast)
str(tsForecast)
autoplot(tsForecast, KWH)

```

missing data
```{r}

InterpolateBetweenRows <- function(df, column, rowNumber) {

lo = rowNumber-1
hi = rowNumber+1

df1 <- filter(df, row_number() == lo)
df2 <- filter(df, row_number() == hi)
x = (df1[,column] + df2[,column])/2
df[rowNumber, column] = x
return (df)


}

tsForecastTest <- tsForecast %>%
  dplyr::filter(row_number()>120 & row_number()<140)
autoplot(tsForecastTest, KWH)

which(is.na(tsForecast$KWH))

tsForecast2 <- InterpolateBetweenRows(tsForecast, "KWH", 129)

tsForecastTest <- tsForecast2 %>%
  dplyr::filter(row_number()>120 & row_number()<140)
autoplot(tsForecastTest, KWH)

```

Could do average interpolation, or multiply by 7



```{r}

boxplot(tsForecast2$KWH)
min <- tsForecast2 |> dplyr::filter(KWH == 770523)

tsForecastTest2 <- tsForecast2 %>%
  dplyr::filter(CaseSequence>873 & CaseSequence<893)
autoplot(tsForecastTest2, KWH)

tsForecast3 <- tsForecast2 |>
  mutate(KWH = ifelse(CaseSequence==883,7705230,KWH)) 
  
tsForecastTest3 <- tsForecast3 %>%
  dplyr::filter(CaseSequence>873 & CaseSequence<893)
autoplot(tsForecastTest3, KWH)

min2 <- InterpolateBetweenRows(tsForecast, "KWH", 11)
min2[11, "KWH"]

```
```{r}
tsForecast4 <-tsForecast3 %>%
  dplyr::select(KWH)

  stl<- tsForecast4 %>%
  stl(s.window ="periodic")
  forecast::autoplot(stl)


```

Test  Models KWH


```{r}

tsForecast5 <- tsForecast4 |>
  mutate(KWH=log(KWH))
  
train1 <- tsForecast5 %>%
  filter_index(~ "2009 Dec")

test1 <- tsForecast5 %>%
  filter_index("2010 Jan" ~ .)

fit <- train1 %>%
  model(SNAIVE = SNAIVE(), ETS_AAN = ETS(KWH ~ error("A") + trend("A") + season("N")), ETS_AAA = ETS(KWH ~ error("A") + trend("A") + season("A")), ETS_AAdA = ETS(KWH ~ error("A") + trend("Ad", phi=.85) + season("A")), ARIMA=ARIMA(KWH))

resids <- function(model) {
a <- fit[model] %>% gg_tsresiduals + labs(title=model)
return (a)
}
```

```{r, include=FALSE}

z <- list()
plot_list <- list()

for (i in names(fit)) {
  index=1
  
  x <- resids(i)
  p <- eval(substitute(x, list(i=index)))
  plot_list[[i]] <- p 
  
  index=index+1
}
```

```{r, fig.height=9}

grid.arrange(grobs=c(plot_list$SNAIVE[1:3], plot_list$ETS_AAN[1:3], plot_list$ETS_AAA[1:3], plot_list$ETS_AAdA[1:3], plot_list$ARIMA[1:3]), ncol=3)

```

```{r, fig.height=4}

fc <- fit %>%
  forecast(test1)

fc %>% forecast::autoplot(tsForecast5) + labs(title = "KWH") 

fit %>% accuracy()
fc %>% accuracy(test1)
```
